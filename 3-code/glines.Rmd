---
title: "glines"
author: "L. Naslund"
date: "2023-12-08"
output: html_document
---

Glines Canyon Dam impounded Lake Mills: the upstream of the two reservoirs on the Elwha River
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rnaturalearth)
library(tidyverse)
library(sf)
library(raster)
library(mapview)
library(lme4)
library(MuMIn)
library(readxl)
library(merTools)
library(elevatr)

# load shapefiles of the reservoir outline and watershed
res <- st_read("../1-input-data/1-geospatial/reservoirs/glines_res.shp")
ws <- st_read("../1-input-data/1-geospatial/watersheds/glineswatershed.shp")

mapview(res)

# build summary data frame of fluxes to export
summary_df <- data.frame(period = character(), flux = character(), variation = character(), flux_unit = character(), annual = character(), area = character(), mean = double(), ci_lwr = double(), ci_upr = double())
```

```{r reservoir and catchment characteristics}
## g-res required inputs
# catchment area (km2)
ws_area <- st_area(ws)
print(paste0("Catchment area (km2): ", round(ws_area * 1e-6, 2)))

# gres required inputs
ws_pop <- 0
print(paste0("Population in the catchment: ", ws_pop))

# community wastewater treatment
wwtp <- "primary"
print(paste0("Wastewater treatment: ", wwtp))

# land cover (proportion)
glines_lc <- read.csv("../1-input-data/3-gres/glines_lc.csv") %>% 
  mutate(gres_class = case_when(
    Legend == "Open Water" ~ "Water Bodies", 
    Legend == "Perennial Snow/Ice" ~ "Permanent Snow/Ice",
    Legend == "Developed, Open Space" ~ "Settlements", 
    Legend == "Developed, Low Intensity" ~ "Settlements", 
    Legend == "Developed, Medium Intensity" ~ "Settlements", 
    Legend == "Developed, High Intensity" ~ "Settlements", 
    Legend == "Barren Land" ~ "Bare Areas",
    Legend == "Deciduous Forest" ~ "Forest", 
    Legend == "Evergreen Forest" ~ "Forest", 
    Legend == "Mixed Forest" ~ "Forest", 
    Legend == "Shrub/Scrub" ~ "Grassland/Shrubland", 
    Legend == "Herbaceuous" ~ "Grassland/Shrubland", 
    Legend == "Hay/Pasture" ~ "Croplands", 
    Legend == "Woody Wetlands" ~ "Wetlands", 
    Legend == "Emergent Herbaceuous Wetlands" ~ "Wetlands",
  ))

print("Catchment landcover:")
glines_lc %>% group_by(gres_class) %>% summarize(perc = sum(percent) %>% round(1)) %>% print()

# country
country <- "United States"
print(paste0("Country: ", country))

# coordinates
long <- -123.6
lat <- 48.002
print(paste0("Coordinates: ", lat, ",", long))

# reservoir area (km2) from Stratton & Grant 2019
res_area <- 1.51 *1e6 # convert to m2
print(paste0("Reservoir Area (km2): ", res_area * 1e-6))

# mean depth (m)
mean_depth <- 23.2
print(paste0("Mean Depth (m): ", mean_depth))

# max depth (m)
max_depth <- 45
print(paste0("Max Depth (m): ", max_depth))

# littoral area (%) Output from g-res given from max and mean depth
lit_area <- 6.277
print(paste0("Littoral Area (%): ", lit_area))

# thermocline depth (m) Output from g-res
thermo_depth <- 3.3
print(paste0("Thermocline depth (m): ", thermo_depth))

# soil carbon (kg C/m2)
soil_carbon <- 7.18
print(paste0("Soil carbon under impounded area (kgC/m2): ", soil_carbon))

# reservoir wind (m/s)
res_wind <- 4.46
print(paste0("Reservoir wind at 50 m: ", res_wind))

# water residence time (yrs) Output from g-res
wrt <- 0.0287
print(paste0("Water residence time (yrs): ", wrt))

# annual discharge (m3/s)
q_annual <- 38.71
print(paste0("Annual Discharge (m3/s): ", q_annual))

# p concentration (ug/L) Output from g-res
p_conc <- 5.4
print(paste0("P Concentration (ug/L): ", p_conc))

# global horizontal radiance (kWh/m2/day)
rad <- 3.4
print(paste0("Global horizontal radiance: ", rad))

# mean temperature per month (C)
temperature <- data.frame(Jan = 2, Feb = 3.6, Mar = 5.1, Apr = 7.3, May = 10.3, June = 13.2, July = 15.5, Aug = 16.0, Sept = 13.3, Oct = 9.1, Nov = 4.6, Dec = 2.4) %>% pivot_longer(cols = Jan:Dec, names_to = "Month", values_to = "Temperature")
print("Temperature per month (C)")
temperature
```

# Before

## Reservoir surface emissions

**G-res tool**

https://131.datatrium.com/fmi/webd/G-res%20Tool?script=ChoiceWebPage&param=Grestool&homeurl=https://g-res.hydropower.org

**Required data**

Must know

- reservoir age
- P concentration (ug/L) or population in the catchment and category of wastewater treatment
- water residence time or mean depth
- reservoir area (km^2)
- reservoir climate zone
- maximum depth
- mean depth or volume

Can be derived from other inputs

- % littoral area
- water residence time

Can be calculated from Google Earth Engine script given a delineated catchment with 
https://code.earthengine.google.com/db5542fcc97469961bfd890123aa55df

- mean annual air temperature (C)
- reservoir surface soil carbon content (kgC m^-2)
- cumulative global horizontal radiance (kWh m^-2 d-1)
- catchment area (km2)
- annual runoff (mm/yr)
- catchment landcover (%)
- k factor (soil erodibility factor)
- mean basin slope

Can delineate catchments in US reservoirs using the StreamStats tool 
https://streamstats.usgs.gov/ss/ 

```{r surface emissions}
## output from g-res: emissions in g CO2 eq/m2/yr by pathway
res_co2_diff_eq <- 36
res_ch4_diff_eq <- 44 * 0.6
res_ch4_eb_eq <- 44 * 0.23
res_ch4_degas_eq <- 44 * 0.17

# calculate total emissions in CO2 eq/m2/yr with degassing
res_degas_eq <- res_ch4_diff_eq + res_ch4_eb_eq +res_ch4_degas_eq + res_co2_diff_eq

# G-res only reports a 95% CI for the net GHG footprint which accounts for landscape GHG emissions before dam construction
# Based on the documentation, I don't think uncertainty in emissions prior to dam construction contributes to the CI,
# so I calculated the post-impoundment emissions 95% CI by subtracting the net GHG footprint CI from mean net GHG footprint
res_degas_net <- 367
res_degas_net_2.5 <- 359
res_degas_net_97.5 <- 377

# I believe due to rounding, the upper and lower intervals are not symmetric, so I selected the larger one to calculate post-impoundment emissions 95% CI
res_degas_eq_interval <- max(c((res_degas_net-res_degas_net_2.5),(res_degas_net_97.5-res_degas_net)))

# calculate emissions in g C/m2/yr with degassing
res_degas_g <- (res_co2_diff_eq * (12.01/44.01)) + 
  ((res_ch4_diff_eq+res_ch4_eb_eq+res_ch4_degas_eq) *(12.01/16.04) * (1/34))

res_degas_g_interval <- (res_degas_eq_interval * (res_co2_diff_eq/res_degas_eq) * (12.01/44.01)) + 
  ((res_degas_eq_interval * ((res_ch4_diff_eq+res_ch4_eb_eq+res_ch4_degas_eq)/res_degas_eq) * (1/34) *(12.01/16.04)))

# calculate emissions in g CO2 eq/m2/yr without degassing
res_eq <- res_co2_diff_eq+res_ch4_diff_eq+res_ch4_eb_eq

res_net_eq <- 360
res_net_2.5_eq <- 352
res_net_97.5_eq <- 369

res_eq_interval <- max(c((res_net_eq - res_net_2.5_eq),(res_net_97.5_eq-res_net_eq)))

# calculate emissions in g C/m2/yr without degassing
res_g <- (res_co2_diff_eq * (12.01/44.01)) + ((res_ch4_diff_eq+res_ch4_eb_eq) *(12.01/16.04) * (1/34))

res_g_interval <- (res_eq_interval * (res_co2_diff_eq/res_eq) * (12.01/44.01)) + 
  ((res_eq_interval * ((res_ch4_diff_eq+res_ch4_eb_eq)/res_eq) * (1/34) *(12.01/16.04)))

res_emissions_summary <- data.frame(period = c("before"), flux = c("reservoir emissions"), variation = c("with degassing", "with degassing", "without degassing", "without degassing"), flux_unit = rep(c("CO2-eq", "C"),2), annual = "yes", area = "reservoir", mean = c(res_degas_eq, res_degas_g, res_eq, res_g), ci_lwr = c(res_degas_eq - res_degas_eq_interval, res_degas_g - res_degas_g_interval, res_eq - res_eq_interval, res_g - res_g_interval), ci_upr = c(res_degas_eq + res_degas_eq_interval, res_degas_g + res_degas_g_interval, res_eq + res_eq_interval, res_g + res_g_interval))
```

## Reservoir carbon burial
```{r carbon burial}
# Means are from table 3 in Stratton et al. 2019, SD for volume from USBR 2011 and SD for bulk density and C content from Wing 2014
# I am assuming that in USBR 2011, when they say uncertainty they mean the 95% CI
sediment_volume <- 1.51e7 # m3
sediment_volume_sd <- (2700000 *0.764555)/1.96 # conversion from yd3 to m3

# calculated bulk density from table 3 Stratton et al. 2019 which reports both volume and mass of sediment
bulk_density <- 2.03e13/1.51e7 #g m-3
bulk_density_sd <- 0.29 * 1e6 #g cm-3 to g m-3

c_content <- (320 * 1e9)/2.03e13 # Gg to g / g
c_content_sd <- 0.83 *1e-2 # % to proportion

# calculate parameters for a gamma distribution because C content can't be negative
b = (c_content_sd)^2/c_content
a = (c_content)^2/(c_content_sd)^2

# 83 is the  number of years between when the reservoir was created until the survey was taken to generate volume estimates
burial_vec <- c()
for(i in 1:10000){
  temporary <- (rnorm(1, sediment_volume, sediment_volume_sd) * rnorm(1, bulk_density, bulk_density_sd) * rgamma(1, shape=a, scale = b))/(res_area * 83)
  burial_vec <- c(burial_vec, temporary)
}

burial_vec <- sort(burial_vec)

res_burial_summary <- data.frame(period = c("before"), flux = c("reservoir burial"), variation = NA, flux_unit = c("CO2-eq", "C"), annual = "yes", area = "reservoir", mean = c(-burial_vec[5000]*(44.01/12.01), -burial_vec[5000]), ci_lwr = c(-burial_vec[9750]*(44.01/12.01), -burial_vec[9750]), ci_upr = c(-burial_vec[250]*(44.01/12.01), -burial_vec[250]))
```

# Burp

## Exposed sediment CO2 emissions
```{r literature sed co2 emissions}
keller_res <- read_csv("../1-input-data/4-exposed-sediment-emissions/Keller_NatureCommunications_2020_data.csv", skip = 6) %>% slice(-1) %>% 
  filter(`system type` == "reservoir") %>% 
  mutate(co2_flux = as.numeric(`CO2 flux dry sediment`) * 1e-3 * 44.01 * 365, moisture_num = as.numeric(moisture)) # mmol/m2/day -> g CO2/m2/yr

other_sed_co2 <- read_csv("../1-input-data/4-exposed-sediment-emissions/additional_exposed_sed_flux.csv") %>% 
  mutate(co2_flux = flux_mgC_m2_day * 1e-3 *365 * (44.01/12.01)) # convert mg C/m2/day to g CO2/m2/yr

exp_sed_co2 <- other_sed_co2 %>% dplyr::select(co2_flux)  %>% bind_rows(keller_res %>% dplyr::select(co2_flux)) 

png("../2-output-data/exposed_sed_co2.png", width = 9, height = 5, units = "in", res = 300)
exp_sed_co2 %>% ggplot(aes(co2_flux))+geom_histogram() + 
  xlab(expression(CO[2]~flux~g~m^-2~yr^-1))+
  theme_bw()+
  theme(axis.text = element_text(size = 12), axis.title = element_text(size = 16))
dev.off()
```

```{r sed co2 emissions}
# find exponential decay constants that lead 0.1 g/m2/yr in different number of years
# plot with initial value = mean measured value, this is only for visualization purposes
# the below loop 
a <- mean(exp_sed_co2$co2_flux)

years <- c(1/12, 1, 5, 10, 30, 100)
rates <- (0.1/a)^(1/years)

x <- seq(0, 100, by = 0.5)
for(i in 1:length(rates)){
  y <- a*(rates[i]^x)
  plot(x, y, type = "l")
}

integrand <- function(x){a*b^x}

# calculate for every possible starting CO2 value and rate
df <- data.frame(a=double(), y = double(), b=double(), total=double())

for(j in 1:10000){ 
  print(j)
  a <- sample(exp_sed_co2$co2_flux, 1, replace = T)

  for(i in 1:length(years)){
    b <-(0.1/a)^(1/years[i])
    total <- integrate(integrand, 0, 100)[[1]]
    y <- years[i]

    temporary <- data.frame(a = a, y = y, b = b, total = total)
    df <- df %>% bind_rows(temporary)
  }
}

res_exp_sed_co2 <- df %>%
  mutate(total_co2_eq = total, total_c = total * (12.01/44.01)) %>%
  group_by(y) %>%
  arrange(total_co2_eq) %>%
  summarize(count = n(),
            mean_co2 = total_co2_eq[count * 0.5],
            lwr_co2 = total_co2_eq[count*0.025],
            upr_co2 = total_co2_eq[count *0.975],
            mean_c = total_c[count * 0.5],
            lwr_c = total_c[count * 0.025],
            upr_c = total_c[count * 0.975],
            sed_co2_eq = paste0(round(mean_co2, 0), " (", round(lwr_co2,0), " - ", round(upr_co2, 0), ")"),
            sed_gC = paste0(round(mean_c, 1), " (", round(lwr_c,1), " - ", round(upr_c, 1), ")"))

write.csv(res_exp_sed_co2, "../2-output-data/exp_sed_co2_sampled.csv", row.names = FALSE)

res_exp_sed_co2 <- read.csv("../2-output-data/exp_sed_co2_sampled.csv")

res_sed_co2_summary <- data.frame(period = "burp", flux = "exposed sediment CO2", variation = rep(c(res_exp_sed_co2$y %>% as.character()), 2), flux_unit = c(rep("CO2-eq", 6), rep("C", 6)), annual = "no", area = "exposed sediment area", mean = c(res_exp_sed_co2$mean_co2, res_exp_sed_co2$mean_c), ci_lwr = c(res_exp_sed_co2$lwr_co2, res_exp_sed_co2$lwr_c), ci_upr = c(res_exp_sed_co2$upr_co2, res_exp_sed_co2$upr_c))
```

## Exposed sediment CH4 emissions
```{r sed ch4 emissions}
sed_ch4_avg = 36 * 1e-3 * 365 # conversion from mg CH4 m-2 d-1 to g CH4 /m2/yr
sed_ch4_sd = 78 * 1e-3 * 365

years <- c(1/12, 1, 5, 10, 30, 100)

df <- data.frame(a=double(), y = double(), b=double(), total=double(), sign = character())

integrand <- function(x){a_pos*b^x}

for(j in 1:10000){
  a <- rnorm(1, sed_ch4_avg, sed_ch4_sd)
  
  # integration won't work if the starting value is less than the threshold value 0.01
  if(-0.01 < a & a < 0.01){
    next
  }
  
  sign <- if_else(a > 0, "pos", "neg")
  
  for(i in 1:length(years)){
    y <- years[i]
    
    if(sign == "neg"){ # this is to deal with the potential for CH4 uptake into drying reservoir sediments
      a_pos <- -a
      b <-(0.01/a_pos)^(1/years[i])
      total <- tryCatch(integrate(integrand, 0, 100)[[1]] * -1,  error = function(e){NA})
    }
    
    if(sign == "pos"){
      a_pos <- a
       b <-(0.01/a_pos)^(1/years[i])
       total <- tryCatch(integrate(integrand, 0, 100)[[1]], error = function(e){NA})
    }
    
    temporary <- data.frame(a = a, y = y, b = b, total = total, sign = sign)
    df <- df %>% bind_rows(temporary)
  }
}

# pore CH4 emissions
# 8102.2 mg C m-2 total CH4 emissions during drying period from Kosten et al. 2018 table 1
pore_co2_eq <- 8102.2 * 1e-3 * (16.04/12.01)* 34
pore_c <- 8102.2 * 1e-3

thresh_0.01 <- df %>%
  mutate(total_co2_eq = total * 34, total_c = total * (12.01/16.04)) %>%
  group_by(y) %>%
  arrange(total_co2_eq) %>%
  summarize(count = n(),
            mean_co2 = total_co2_eq[count * 0.5],
            lwr_co2 = total_co2_eq[count*0.025],
            upr_co2 = total_co2_eq[count *0.975],
            mean_c = total_c[count * 0.5],
            lwr_c = total_c[count * 0.025],
            upr_c = total_c[count * 0.975],
            sed_ch4_co2_eq = paste0(round(mean_co2, 0), " (", round(lwr_co2,0), " - ", round(upr_co2, 0), ")"),
            sed_ch4_gC = paste0(round(mean_c, 1), " (", round(lwr_c,1), " - ", round(upr_c, 1), ")"),
            sed_ch4_co2_eq_pore = paste0(round(mean_co2 + pore_co2_eq, 0), " (", round(lwr_co2 + pore_co2_eq,0), " - ", round(upr_co2 +pore_co2_eq, 0), ")"),
            sed_ch4_gC_pore = paste0(round(mean_c +pore_c, 1), " (", round(lwr_c+pore_c,1), " - ", round(upr_c+pore_c, 1), ")"))

write.csv(thresh_0.01, "../2-output-data/glines_exp_sed_ch4.csv", row.names = FALSE)

thresh_0.01 <- read.csv("../2-output-data/glines_exp_sed_ch4.csv")

res_sed_ch4_summary <- data.frame(period = c("burp"), flux = c("exposed sediment CH4"), variation = c(rep(paste0("no_pore_", thresh_0.01$y), 2), rep(paste0("pore_", thresh_0.01$y), 2)), flux_unit = rep(c(rep("CO2-eq", 6), rep("C", 6)), 2), annual = "no", area = "exposed sediment area", mean = c(thresh_0.01$mean_co2,  thresh_0.01$mean_c, thresh_0.01$mean_co2 + pore_co2_eq, thresh_0.01$mean_c + pore_c), ci_lwr = c(thresh_0.01$lwr_co2,  thresh_0.01$lwr_c, thresh_0.01$lwr_co2 + pore_co2_eq, thresh_0.01$lwr_c + pore_c), ci_upr = c(thresh_0.01$upr_co2, thresh_0.01$upr_c, thresh_0.01$upr_co2 + pore_co2_eq, thresh_0.01$upr_c + pore_c))
```

## Drawdown ebullition 
```{r drawdown ebullition}
res_ch4_eb_eq_2.5 <- res_ch4_eb_eq - res_eq_interval
res_ch4_eb_eq_97.5 <- res_ch4_eb_eq + res_eq_interval

drawdown_eb_prop <- c(0, 5, 10, 25, 100)

res_ch4_eb_g <- res_ch4_eb_eq * (1/34) * (12.01/16.04)
res_ch4_eb_g_2.5 <- res_ch4_eb_eq_2.5 * (1/34) * (12.01/16.04)
res_ch4_eb_g_97.5 <- res_ch4_eb_eq_97.5 * (1/34) * (12.01/16.04)

res_drawdown_eb_summary <- data.frame(period = c("burp"), flux = c("drawdown ebullition"), variation = drawdown_eb_prop %>% as.character(), flux_unit = c(rep("CO2-eq",5), rep("C", 5)), annual = "no", area = "reservoir", mean = c(res_ch4_eb_eq * drawdown_eb_prop, res_ch4_eb_g * drawdown_eb_prop) , ci_lwr = c(res_ch4_eb_eq_2.5 * drawdown_eb_prop, res_ch4_eb_g_2.5 * drawdown_eb_prop) , ci_upr = c(res_ch4_eb_eq_97.5 * drawdown_eb_prop, res_ch4_eb_g_97.5 * drawdown_eb_prop))
```

## Eroded sediment emissions
```{r eroded sed emissions}
# Initially missed the additional 1e6 double check again
res_erode_g <- 9.1 * 1e6 * 1e6
res_erode_g_sd <- 1.8 * 1e6 * 1e6

# parameters for g distribution of % C
b = (c_content_sd)^2/c_content
a = (c_content)^2/(c_content_sd)^2

# assumming between 0 and 100% oxidized
min_ox_trans = 0 
max_ox_trans = 1

eroded_vec <- c()
for(i in 1:10000){
  temporary <- (rnorm(1, res_erode_g, res_erode_g_sd) * rgamma(1, shape=a, scale = b) * runif(1, min = min_ox_trans, max = max_ox_trans))/(res_area)
  eroded_vec <- c(eroded_vec, temporary)
}

eroded_vec <- sort(eroded_vec)

res_erode_summary <- data.frame(period = c("burp"), flux = c("eroded sediment emissions"), variation = NA, flux_unit = c("CO2-eq", "C"), annual = "no", area = "reservoir", mean = c(eroded_vec[5000] * (44.01/12.01), eroded_vec[5000]), ci_lwr = c(eroded_vec[250] * (44.01/12.01), eroded_vec[250]), ci_upr = c(eroded_vec[9750] * (44.01/12.01), eroded_vec[9750]))
```


```{r which parameter of eroded most uncertain}
# Initially missed the additional 1e6 double check again
res_erode_g <- 9.1 * 1e6 * 1e6
res_erode_g_sd_alt <- (1.8 * 1e6 * 1e6) * 0.9

# parameters for g distribution of % C
b = (c_content_sd)^2/c_content
a = (c_content)^2/(c_content_sd)^2

# assumming between 0 and 100% oxidized
min_ox_trans = 0 
max_ox_trans = 1

eroded_vec_alt <- c()
for(i in 1:10000){
  temporary <- (rnorm(1, res_erode_g, res_erode_g_sd_alt) * rgamma(1, shape=a, scale = b) * runif(1, min = min_ox_trans, max = max_ox_trans))/(res_area)
  eroded_vec_alt <- c(eroded_vec_alt, temporary)
}

eroded_vec_alt <- sort(eroded_vec_alt)

res_erode_summary_alt <- data.frame(period = c("burp"), flux = c("eroded sediment emissions"), variation = NA, flux_unit = c("CO2-eq", "C"), annual = "no", area = "reservoir", mean = c(eroded_vec_alt[5000] * (44.01/12.01), eroded_vec_alt[5000]), ci_lwr = c(eroded_vec_alt[250] * (44.01/12.01), eroded_vec_alt[250]), ci_upr = c(eroded_vec_alt[9750] * (44.01/12.01), eroded_vec_alt[9750]))

res_erode_summary_alt
```


# Build

## River surface CO2 emissions
```{r river co2 emissions}
# Discharge is in the 10-100 m3/s bin
# Values are reported as g C m-2 d-

gamma_params_diff <- function(params, quantiles_target) {
  shape <- params[1]
  scale <- params[2]
  
  quantiles_observed <- qgamma(c(0.25, 0.5, 0.75), shape = shape, scale = scale)
  
  sum((quantiles_observed - quantiles_target)^2)
}

# Target quantiles of CO2 emissions from Hotchkiss et al. 2015 for rivers with Q 10-100 m3 s-1
quantiles_target <- c(1.58, 2.50, 4.36)

# Initial guess for shape and scale parameters
initial_params <- c(shape = 1, scale = 1)

# Optimize the parameters
optimized_params <- optim(par = initial_params, fn = gamma_params_diff, quantiles_target = quantiles_target)

# Extract optimized parameters
shape_optimized <- optimized_params$par[1]
scale_optimized <- optimized_params$par[2]

# Check the quantiles with the optimized parameters
quantiles_optimized <- qgamma(c(0.25, 0.5, 0.75), shape = shape_optimized, scale = scale_optimized)
cat("Optimized Quantiles:", quantiles_optimized, "\n")

riv_co2_vec <- sort(rgamma(10000, shape = shape_optimized, scale = scale_optimized)) *365

riv_co2_summary <- data.frame(period = c("build"), flux = c("river CO2 emissions"), variation = NA, flux_unit = c("CO2-eq", "C"), annual = "yes", area = "river", mean = c(riv_co2_vec[5000] * (44.01/12.01), riv_co2_vec[5000]), ci_lwr = c(riv_co2_vec[250] * (44.01/12.01), riv_co2_vec[250]), ci_upr = c(riv_co2_vec[9750] * (44.01/12.01), riv_co2_vec[9750]))
```

## River surface CH4 emissions
```{r river ch4 emissions}
ch4_conc <- read.csv("../1-input-data/5-ch4-fluxes/GRiMe_concentrations_v2.csv") 
ch4_flux <- read.csv("../1-input-data/5-ch4-fluxes/GRiMe_fluxes_v2.csv")
ch4_flux_sites <- read.csv("../1-input-data/5-ch4-fluxes/GRiMe_sites_v2.csv")
ch4_source <- read.csv("../1-input-data/5-ch4-fluxes/GRiMe_sources_v2.csv")

usa <- ne_countries(country = "united states of america")

ch4_flux_sf <- ch4_flux %>% 
  left_join(ch4_flux_sites, by = c("Source_ID", "Site_ID", "Site_Name")) %>% 
  left_join(ch4_conc %>% 
              filter(FluxYesNo == "Yes") %>% 
              rename("Flux_Name" = "Conc_Name"), 
            by = c("Source_ID", "Site_ID", "Site_Name", "Flux_Name")) %>% 
  filter(is.na(Longitude)==FALSE, is.na(Channel_type)==TRUE) %>% 
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) 

# filter sites in us
ch4_flux_sites_usa <- st_intersection(usa, ch4_flux_sf) %>% dplyr::select(Source_ID:geometry)
mapview(ch4_flux_sites_usa)

# Does it make sense to bin by discharge just because Hotckiss et al. 2015 did if discharge is not explanatory?
ch4_flux_sites_usa %>% ggplot(aes(Q, Diffusive_CH4_Flux_Mean))+geom_point()
ch4_flux_sites_usa %>% filter(Q < 500 & Diffusive_CH4_Flux_Mean<45) %>% ggplot(aes(Q, Diffusive_CH4_Flux_Mean))+geom_point()

# Elwha measurements
elwha <- ch4_flux_sites_usa %>% filter(Site_Name == "Elwha River")

# glines CO2 mmol m-2 d- -> g CO2 m2 yr
elwha$CO2_Flux_Mean * 365 * 1e-3 * 44.01

# glines CH4 mmol m2 day
elwha$Diffusive_CH4_Flux_Mean * 365 * 1e-3 * 16.04

ch4_flux_sites_usa <- ch4_flux_sites_usa %>% mutate(q_bin = case_when(
  (Q>=0 & Q<0.01) ~ "0-0.01",
  (Q>0.01 & Q<0.1) ~ "0.01-0.1",
  (Q>0.1 & Q<1) ~ "0.1-1",
  (Q>1 & Q<10) ~ "1-10",
  (Q>10 & Q<100) ~ "10-100",
  (Q > 100) ~ ">100"
)) 

# summary of diffusive CH4 by bin
ch4_flux_sites_usa %>% filter(is.na(Diffusive_CH4_Flux_Mean)==FALSE) %>% group_by(q_bin) %>% summarize(count = n())

# no measurements of ebullition in the Q range so assuming it is zero. This is another caveat we will need to address
ch4_flux_sites_usa %>% filter(is.na(Eb_CH4_Flux_Mean)==FALSE) %>% group_by(q_bin) %>% summarize(count = n())

ch4_flux_vec <- sort(sample(ch4_flux_sites_usa %>% filter(q_bin== "10-100") %>% pull(Diffusive_CH4_Flux_Mean), 10000, replace = TRUE))
ch4_flux_vec_gCH4 <- ch4_flux_vec * 365 * 1e-3 * 16.04 # mmol/m2/d -> g CH4/m2/yr
ch4_flux_vec_gCO2eq <- ch4_flux_vec_gCH4 * 34


riv_ch4_flux_97.5_gC <- ch4_flux_vec_gCH4[9750] * (12.01 / 16.04)
riv_ch4_flux_gC <- ch4_flux_vec_gCH4[5000] * (12.01 / 16.04)
riv_ch4_flux_2.5_gC <- ch4_flux_vec_gCH4[250] * (12.01 / 16.04)

riv_ch4_flux_97.5_gCO2eq <- ch4_flux_vec_gCO2eq[9750]
riv_ch4_flux_gCO2eq <- ch4_flux_vec_gCO2eq[5000]
riv_ch4_flux_2.5_gCO2eq <- ch4_flux_vec_gCO2eq[250]

# CO2 flux
co2_vec <- sort(sample(ch4_flux_sites_usa %>% filter(is.na(CO2_Flux_Mean)==FALSE)  %>% filter(q_bin== "10-100") %>% pull(CO2_Flux_Mean), 10000, replace = TRUE))* 365 * 1e-3 * 44.01
co2_vec[250]
co2_vec[5000]
co2_vec[9750]

riv_ch4_summary <- data.frame(period = c("build"), flux = c("river CH4 emissions"), variation = NA, flux_unit = c("CO2-eq", "C"), annual = "yes", area = "river", mean = c(riv_ch4_flux_gCO2eq, riv_ch4_flux_gC), ci_lwr = c(riv_ch4_flux_2.5_gCO2eq, riv_ch4_flux_2.5_gC), ci_upr = c(riv_ch4_flux_97.5_gCO2eq, riv_ch4_flux_97.5_gC))
```

## NEE
```{r NEE}
f_age <- function(a, b, e, age){
  return(e + a * (1-exp(b*age)))
}

# g C/m2/yr
df <- read.csv("../1-input-data/8-besnard-data/besnard_2018.csv") %>% mutate(age_func = f_age(263.2, -0.19, 0, Age)) %>% mutate(nutrient = as.factor(`NA.`))

# estimating NEP assuming that it is zero before the model predicts positive values
nep_mod <- lm(NEP ~ MAT + Age + age_func + nutrient, data = df)
summary(nep_mod)

nep_new <- data.frame(MAT = mean(temperature$Temperature), Age = seq(0, 100, by = 1), age_func = f_age(263.2, -0.19, 0, seq(0, 100, by = 1)), nutrient =as.factor("L"))

nep_pred <- predict(nep_mod, nep_new, interval = "prediction") %>% as.data.frame()

# becomes 0 a little before 5.7 years in so going to call it 6

nep_df <- data.frame(years = double(), mean_gC = double(), lwr_gC = double(), upr_gC = double())

year_vec <- c(25,50,100)
for(i in 1:length(year_vec)){
  yr <- year_vec[i]
  mean_gC <- integrate(function(x) as.data.frame(predict(nep_mod, newdata = data.frame(MAT = mean(temperature$Temperature), Age = x, age_func = f_age(263.2, -0.19, 0, x), nutrient =as.factor("L")), interval = "prediction", level = 0.95))$fit, lower = 6, upper = yr)$value
  lwr_gC <- -(integrate(function(x) -(as.data.frame(predict(nep_mod, newdata = data.frame(MAT = mean(temperature$Temperature), Age = x, age_func = f_age(263.2, -0.19, 0, x), nutrient =as.factor("L")), interval = "prediction", level = 0.95))$lwr), lower = 6, upper = yr))$value
  upr_gC <- integrate(function(x) as.data.frame(predict(nep_mod, newdata = data.frame(MAT = mean(temperature$Temperature), Age = x, age_func = f_age(263.2, -0.19, 0, x), nutrient =as.factor("L")), interval = "prediction", level = 0.95))$upr, lower = 6, upper = yr)$value
  
  temporary <- data.frame(years = yr, mean_gC = -mean_gC, lwr_gC = -upr_gC, upr_gC = -lwr_gC) # switching these numbers so the emissions are in up_gC (because NEP signs are flipped from convention I'm using)
  
  nep_df <- nep_df %>% bind_rows(temporary)
}

# integrated carbon
nep_df <- nep_df %>% mutate(mean_gCO2 = mean_gC * (44.01/12.01), lwr_gCO2 = lwr_gC * (44.01/12.01), upr_gCO2 = upr_gC * (44.01/12.01))

# average annual rates
nep_df_rates <- nep_df %>% mutate(across(mean_gC:upr_gCO2, ~ .x / years))

nep_df_rates

res_nep_summary <- data.frame(period = c("build"), flux = c("NEP"), variation = nep_df_rates$years %>% as.character(), flux_unit = c(rep("CO2-eq", 3), rep("C", 3)), annual = "yes", area = "exposed sediment area", mean = c(nep_df_rates$mean_gCO2, nep_df_rates$mean_gC), ci_lwr = c(nep_df_rates$lwr_gCO2, nep_df_rates$lwr_gC), ci_upr = c(nep_df_rates$upr_gCO2, nep_df_rates$upr_gC))

res_nep_summary

# emission of carbon in 5.7 years, 3X higher the sediment CO2 emissions over the same period
integrate(function(x) as.data.frame(predict(nep_mod, newdata = data.frame(MAT = mean(temperature$Temperature), Age = x, age_func = f_age(263.2, -0.19, 0, x), nutrient =as.factor("L")), interval = "prediction", level = 0.95))$fit, lower = 0, upper = 5.7)$value
```

## Soil CH4 emissions
```{r soil CH4}
soil <- read.csv("../1-input-data/7-gattica-data/MethaneSoilForest.csv") %>% mutate(MAP_sq = MAP^2, MAT_sq = MAT^2) %>% filter(complete.cases(.))

soil_scale <- soil %>% mutate(across(c(MAP:soilpH, MAP_sq, MAT_sq), scale))

soil_mod <- lmer(Methane ~ MAP*MAT + soilpH + SOC + BulkDens + MAT_sq + SoilNit + MAP_sq + SoilSand + (1 + MAP*MAT + soilpH + SOC + BulkDens + MAT_sq + SoilNit + MAP_sq + SoilSand| Biome), data = soil_scale)

# I am not getting the same AICc
summary(soil_mod)

library(performance)
r2_nakagawa(soil_mod)

AICc(soil_mod, REML = FALSE)
AICc(soil_mod, REML = TRUE)

glines_soil <- read.csv("../1-input-data/7-gattica-data/glines_soil.csv")

# going to have to manually scale                                                         
soil_data_new <- data.frame(MAP = (glines_soil$glines_map- mean(soil$MAP))/sd(soil$MAP),
                            MAT = (glines_soil$glines_mat - mean(soil$MAT))/sd(soil$MAT), 
                            soilpH = (glines_soil$glines_ph - mean(soil$soilpH))/sd(soil$soilpH), 
                            SOC = (glines_soil$glines_oc - mean(soil$SOC))/sd(soil$SOC), 
                            BulkDens = (glines_soil$glines_bd - mean(soil$BulkDens))/sd(soil$BulkDens), 
                            SoilNit = (glines_soil$glines_tn - mean(soil$SoilNit))/sd(soil$SoilNit), 
                            SoilSand = (glines_soil$glines_sand - mean(soil$SoilSand))/sd(soil$SoilSand), 
                            MAT_sq = (glines_soil$glines_mat^2 - mean(soil$MAT_sq))/sd(soil$MAT_sq), 
                            MAP_sq = (glines_soil$glines_map^2 - mean(soil$MAP_sq))/sd(soil$MAP_sq), 
                            Biome = "Temperate")

#MAP*MAT + soilpH + SOC + BulkDens + MAT_sq + SoilNit + MAP_sq + SoilSand + (1 + MAP*MAT + soilpH + SOC + BulkDens + MAT_sq + SoilNit + MAP_sq + SoilSand

# returns values in kg Ch4 /ha/yr
soil_ch4_out <- predictInterval(soil_mod, soil_data_new, n.sims = 10000, level = 0.95) %>% as.data.frame()

soil_ch4_out <- soil_ch4_out %>% mutate(soil_c = fit * 0.1 * (12.01/16.04), # 0.1 is conversion factor from kg/ha to g/m2
                        soil_c_2.5 = lwr * 0.1 * (12.01/16.04), 
                        soil_c_97.5 = upr * 0.1 * (12.01/16.04), 
                        soil_co2_eq = fit * 0.1 * 34, 
                        soil_co2_eq_2.5 = lwr * 0.1 * 34, 
                        soil_co2_eq_97.5 = upr * 0.1 * 34)  
  
soil_ch4_out

res_soil_ch4_summary <- data.frame(period = c("build"), flux = c("soil CH4 emissions"), variation = NA, flux_unit = c("CO2-eq", "C"), annual = "yes", area = "exposed sediment area", mean = c(soil_ch4_out$soil_co2_eq, soil_ch4_out$soil_c), ci_lwr = c(soil_ch4_out$soil_co2_eq_2.5, soil_ch4_out$soil_c_2.5), ci_upr = c(soil_ch4_out$soil_co2_eq_97.5, soil_ch4_out$soil_c_97.5))
```

## Tree CH4 emissions
```{r fvs inputs}
terrace <- st_read("../1-input-data/1-geospatial/post-removal/lake-mills_terrace.shp")
valley_wall <- st_read("../1-input-data/1-geospatial/post-removal/lake-mills_valley-wall.shp")

terrace_slope <- read.csv("../1-input-data/1-geospatial/post-removal/lake-mills_terrace_slope.csv") %>% dplyr::select(stand_id, MEAN) %>% rename("slope" = "MEAN")
terrace_elevation <- read.csv("../1-input-data/1-geospatial/post-removal/lake-mills_terrace_elevation.csv") %>% dplyr::select(stand_id, MEAN) %>% rename("elevation" = "MEAN")
terrace_aspect <- read.csv("../1-input-data/1-geospatial/post-removal/lake-mills_terrace_aspect.csv") %>% dplyr::select(stand_id, MEAN) %>% rename("aspect" = "MEAN")

# coordinates for FVS input
terrace_coords <- terrace %>% st_transform(4326) %>% st_centroid() %>% st_coordinates() %>% as.data.frame()
terrace_coords$stand_id <- terrace_slope$stand_id

# terrace inputs
terrace_inputs <- terrace_slope %>% left_join(terrace_elevation, by = "stand_id") %>% left_join(terrace_aspect, by = "stand_id") %>% left_join(terrace_coords, by = "stand_id")

valley_wall_slope <- read.csv("../1-input-data/1-geospatial/post-removal/lake-mills_valley-wall_slope.csv") %>% dplyr::select(stand_id, MEAN) %>% rename("slope" = "MEAN")
valley_wall_aspect <- read.csv("../1-input-data/1-geospatial/post-removal/lake-mills_valley-wall_aspect.csv") %>% dplyr::select(stand_id, MEAN) %>% rename("aspect" = "MEAN")
valley_wall_elevation <- read.csv("../1-input-data/1-geospatial/post-removal/lake-mills_valley-wall_elevation.csv") %>% dplyr::select(stand_id, MEAN) %>% rename("elevation" = "MEAN")

valley_wall_coords <- valley_wall %>% st_transform(4326) %>% st_centroid() %>% st_coordinates() %>% as.data.frame()
valley_wall_coords$stand_id <- valley_wall_slope$stand_id

valley_wall_inputs <- valley_wall_slope %>% left_join(valley_wall_elevation, by = "stand_id") %>% left_join(valley_wall_aspect, by = "stand_id")%>% left_join(valley_wall_coords, by = "stand_id")

# write.csv(valley_wall_inputs, "../1-input-data/2-fvs/lake-mills_valley-wall.csv")
```

```{r tree ch4}
# These files are the individual tree table outputs from FVS. Every row is a characteristic tree in a 1 acre plot. TPA defines the number of trees in the plot represented by this record
trees_k09 <- read.csv("../1-input-data/2-fvs/lake-mills-output_k09.csv")
trees_k15 <- read.csv("../1-input-data/2-fvs/lake-mills-output_k15.csv")

# tree plots gives the area of each plot in m2
# tree plots total gives you the total regrowth area
tree_plots <- trees_k09 %>% dplyr::select(StandID) %>% distinct() %>% mutate(habitat = if_else(str_detect(StandID, "lmt"), "wetland", "upland"))
tree_plots$area <- c(st_area(terrace) %>% as.numeric(), st_area(valley_wall) %>% as.numeric())

wetland_plots_total <- sum(tree_plots %>% filter(habitat == "wetland") %>% pull(area))
upland_plots_total <- sum(tree_plots %>% filter(habitat == "upland") %>% pull(area))

tree_plots <- tree_plots %>% mutate(total = if_else(habitat == "wetland", wetland_plots_total, upland_plots_total))

# FVS returns an acre of trees for each plot (double check this fact!). This is the m2 in an acre
plot_area <- 4046.86

# This code is calculating the weighted average tree surface area in upland (valley wall) and wetland (terrace) area
tree_surface_area_k09 <- trees_k09 %>% 
  mutate(surface_area = (DBH/12)*pi *EstHt *0.092903 * TPA, surface_area_3m = (DBH/12)*pi * 9.84 *0.092903 * TPA) %>%  # calculate surface area of individual trees in an acre, DBH in inches Ht in ft convert to m2
  group_by(StandID, Year) %>% 
  summarize(total_surface_area = sum(surface_area)/plot_area, total_surface_area_3m = sum(surface_area_3m)/plot_area) %>% # sum plot tree area and divide by plot area to get tree area/ground area
  left_join(tree_plots, by = "StandID") %>% 
  mutate(total_surface_area_w = total_surface_area * (area/total), total_surface_area_3m_w = total_surface_area_3m * (area/total)) %>%  # calculate weighted average surface area/m2 ground area in wetlands vs. uplands
  group_by(habitat, Year) %>% 
  summarize(total_surface_area = sum(total_surface_area_w), total_surface_area_3m = sum(total_surface_area_3m_w)) %>% 
  ungroup()


tree_surface_area_k15 <- trees_k15 %>% 
  mutate(surface_area = (DBH/12)*pi *EstHt *0.092903 * TPA, surface_area_3m = (DBH/12)*pi * 9.84 *0.092903 * TPA) %>%  # calculate surface area of individual trees in an acre, DBH in inches Ht in ft convert to m2
  group_by(StandID, Year) %>% 
  summarize(total_surface_area = sum(surface_area)/plot_area, total_surface_area_3m = sum(surface_area_3m)/plot_area) %>% # sum plot tree area and divide by plot area to get tree area/ground area
  left_join(tree_plots, by = "StandID") %>% 
  mutate(total_surface_area_w = total_surface_area * (area/total), total_surface_area_3m_w = total_surface_area_3m * (area/total)) %>%  # calculate weighted average surface area/m2 ground area in wetlands vs. uplands
  group_by(habitat, Year) %>% 
  summarize(total_surface_area = sum(total_surface_area_w), total_surface_area_3m = sum(total_surface_area_3m_w)) %>% 
  ungroup()

#I think this might already be accounting for areas without trees because this is surface area per m2 ground area

# ug CH4/m2/hr -> g CH4/m2/yr
upland_tree_ch4 <- 68.8 * 8760 *1e-6
upland_tree_ch4_sd <- 53.6 * 8760 *1e-6

wetland_tree_ch4 <- 567.9 * 8760 *1e-6
wetland_tree_ch4_sd <- 523.5 * 8760 *1e-6

# m2 in an acre
plot_area <- 4046.86

angio_ch4_df <- NULL
for(i in 1:10000){
  print(i)

  upland_ch4_rate <- rnorm(1, upland_tree_ch4, upland_tree_ch4_sd)
  wetland_ch4_rate <- rnorm(1, wetland_tree_ch4, wetland_tree_ch4_sd)
  tree_sa <- sample(c(1, 2), size = 1, replace = TRUE)

    # taking the mean over 100 years rather than integrating under the curve and then dividing by 100 years
  if(tree_sa == 1){
    temporary <- tree_surface_area_k09 %>%
      mutate(ch4_all = if_else(habitat == "upland", total_surface_area * upland_ch4_rate, total_surface_area * wetland_ch4_rate),
             ch4_3m = if_else(habitat == "upland", total_surface_area_3m * upland_ch4_rate, total_surface_area_3m * wetland_ch4_rate)) %>%
      summarize(mean_ch4_all = mean(ch4_all),
        mean_ch4_3m = mean(ch4_3m),
        ch4_all_rate_co2 = mean_ch4_all * 34,
        ch4_3m_rate_co2 = mean_ch4_3m * 34)
  }

  if(tree_sa == 2){
      temporary <- tree_surface_area_k15 %>%
      mutate(ch4_all = if_else(habitat == "upland", total_surface_area * upland_ch4_rate, total_surface_area * wetland_ch4_rate),
             ch4_3m = if_else(habitat == "upland", total_surface_area_3m * upland_ch4_rate, total_surface_area_3m * wetland_ch4_rate)) %>%
      summarize(mean_ch4_all = mean(ch4_all),
        mean_ch4_3m = mean(ch4_3m),
        ch4_all_rate_co2 = mean_ch4_all * 34,
        ch4_3m_rate_co2 = mean_ch4_3m * 34)
  }

  angio_ch4_df <- angio_ch4_df %>% bind_rows(temporary)
}

write.csv(angio_ch4_df, "../2-output-data/glines_tree_ch4_emissions_revised.csv")

tree_ch4_df <- read.csv("../2-output-data/glines_tree_ch4_emissions_revised.csv")

ch4_all <- tree_ch4_df$mean_ch4_all %>% sort()
ch4_3m <- tree_ch4_df$mean_ch4_3m %>% sort()

ch4_all_co2 <- tree_ch4_df$ch4_all_rate_co2 %>% sort()
ch4_3m_co2 <- tree_ch4_df$ch4_3m_rate_co2 %>% sort()

res_tree_ch4_summary <- data.frame(period = c("build"), 
                                   flux = c("tree CH4 emissions"), 
                                   variation = c("offset by canopy", "offset by canopy", "whole trunk", "whole trunk", "three meters", "three meters"), 
                                   flux_unit = rep(c("CO2-eq", "C"), 3), 
                                   annual = "yes", 
                                   area = "exposed sediment area", 
                                   mean = c(0, 0, ch4_all_co2[5000], ch4_all[5000] * (12.01/16.04), ch4_3m_co2[5000], ch4_3m[5000]* (12.01/16.04)), 
                                   ci_lwr = c(0, 0, ch4_all_co2[250], ch4_all[250] * (12.01/16.04), ch4_3m_co2[250], ch4_3m[250]* (12.01/16.04)), 
                                   ci_upr = c(0, 0, ch4_all_co2[9750], ch4_all[9750] * (12.01/16.04), ch4_3m_co2[9750], ch4_3m[9750]* (12.01/16.04)))
res_tree_ch4_summary

```


# Summary
```{r}
# The terrace delineation was done using 2014 NAIP data. The flow is now more concentrated in a smaller area meaning there is a greater area of exposed sediments. I don't think this matters because the FVS model is not that sensitive to small changes in aspect, elevation, and slope, so I am moving forward with 2021 delineations for sediment and river area
glines_riv <- read_sf("../1-input-data/1-geospatial/post-removal/elwha-river_glines.shp")

glines_riv_area <- (glines_riv %>% filter(Type == "main") %>% st_area()) - (glines_riv %>% filter(Type != "main") %>% st_area() %>% sum()) 

area_df <- data.frame(area = c("reservoir", "exposed sediment area", "river"), 
                      area_m2 = c(res_area, res_area - as.numeric(glines_riv_area), as.numeric(glines_riv_area)))

# negative values are for uptake or burial positive values are for emissions

summary_df <- bind_rows(res_emissions_summary, res_burial_summary, res_sed_co2_summary, res_sed_ch4_summary, res_drawdown_eb_summary, res_erode_summary, riv_co2_summary, riv_ch4_summary, res_nep_summary, res_soil_ch4_summary, res_tree_ch4_summary) %>% left_join(area_df, by = "area") %>% mutate(mean_area = mean * area_m2, ci_lwr_area = ci_lwr * area_m2, ci_upr_area = ci_upr * area_m2) %>% mutate(flux_fct = fct_relevel(flux, c("reservoir emissions", "reservoir burial", "exposed sediment CO2", "exposed sediment CH4", "drawdown ebullition", "eroded sediment emissions", "river CO2 emissions", "river CH4 emissions", "NEP", "soil CH4 emissions", "tree CH4 emissions")))

write.csv(summary_df, "../2-output-data/glines_summary_20240725.csv", row.names = FALSE)
```

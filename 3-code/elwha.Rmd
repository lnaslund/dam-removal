---
title: "elwha"
author: "L. Naslund"
date: "2023-12-08"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(raster)
library(mapview)

# required geospatial 
res <- st_read("../1-input-data/1-geospatial/reservoirs/elwha_res.shp")
expo_sed <- st_read(NULL)
elev <- raster(NULL) %>% project(crs(res)) %>% crop(res)
lc <- raster(NULL)

ws <- st_read("../1-input-data/1-geospatial/watersheds/elwhawatershed.shp")

# https://websoilsurvey.sc.egov.usda.gov/DataAvailability/SoilDataAvailabilityMap.pdf
soil_soc <- raster(NULL)
soil_k <- raster(NULL)
```

```{r parameter inputs}
# CH4 global warming potential
ch4_co2eq <- 27

# maximum depth to which sediment can be mineralized (in cm)
max_sed_depth <- 1

# max and min values of proportion of exposed sediment which is labile
max_prop_labile <- 1
min_prop_labile <- 0

# max and min proportion of annual ebullition emitted during drawdown
max_eb_prop <- 10
min_eb_prop <- 0

# max and min proportion of sediment OC oxidized in transport
max_ox_trans <- 1
min_ox_trans <- 0

# number of simulations
n <- 10000

# eroded sediment mass
erode_sed <- NULL
```


```{r reservoir and watershed characteristics}
# g-res required inputs 

# catchment area (km2)
ws_area <- st_area(ws)
as.numeric(ws_area) * 1e-6

# population in catchment
ws_pop <- 510


# eventually it would be cool to build this out into a web feature service but for now we could use elevator to get 30 m elevation data or download 3DEP from the National Map

res_area <- st_area(res)
res_slope <- terrain(elev, opt = "slope", unit = "degrees")
sed_expo_area <- st_area(expo_sed)

# TODO add LC calculation
perc_forest <- NULL
perc_crop <- NULL

river_q <- NULL
```

```{r}
## g-res required inputs
# catchment area (km2)
ws_area <- st_area(ws)
print(paste0("Catchment area (km2): ", round(ws_area * 1e-6, 2)))

# gres required inputs
ws_pop <- 510
print(paste0("Population in the catchment: ", ws_pop))

# community wastewater treatment
wwtp <- "primary"
print(paste0("Wastewater treatment: ", wwtp))

# land cover
elwha_lc <- read.csv("../1-input-data/3-gres/elwha_lc.csv") %>% 
  mutate(gres_class = case_when(
    Legend == "Open Water" ~ "Water Bodies", 
    Legend == "Perennial Snow/Ice" ~ "Permanent Snow/Ice",
    Legend == "Developed, Open Space" ~ "Settlements", 
    Legend == "Developed, Low Intensity" ~ "Settlements", 
    Legend == "Developed, Medium Intensity" ~ "Settlements", 
    Legend == "Developed, High Intensity" ~ "Settlements", 
    Legend == "Barren Land" ~ "Bare Areas",
    Legend == "Deciduous Forest" ~ "Forest", 
    Legend == "Evergreen Forest" ~ "Forest", 
    Legend == "Mixed Forest" ~ "Forest", 
    Legend == "Shrub/Scrub" ~ "Grassland/Shrubland", 
    Legend == "Herbaceuous" ~ "Grassland/Shrubland", 
    Legend == "Hay/Pasture" ~ "Croplands", 
    Legend == "Woody Wetlands" ~ "Wetlands", 
    Legend == "Emergent Herbaceuous Wetlands" ~ "Wetlands",
  ))

print("Catchment landcover:")
elwha_lc %>% group_by(gres_class) %>% summarize(perc = sum(percent) %>% round(2))

# country
country <- "United States"
print(paste0("Country: ", country))

# coordinates
long <- -123.557
lat <- 48.0943
print(paste0("Coordinates: ", lat, ",", long))

# reservoir area (km2)
res_area <- 1.1
print(paste0("Reservoir Area (km2): ", res_area %>% round(1)))

# mean depth (m)
mean_depth <- 7.6
print(paste0("Mean Depth (m): ", mean_depth))

# max depth (m)
max_depth <- 29
print(paste0("Max Depth (m): ", max_depth))

# littoral area (%) Output from g-res given from max and mean depth
lit_area <- 26.47
print(paste0("Littoral Area (%): ", lit_area))

# thermocline depth (m) Output from g-res
thermo_depth <- 3.3
print(paste0("Thermocline depth (m): ", thermo_depth))

# soil carbon
soil_carbon <- 7.43
print(paste0("Soil carbon under impounded area (kgC/m2): ", soil_carbon))

# reservoir wind
res_wind <- 4.46
print(paste0("Reservoir wind at 50 m: ", res_wind))

# water residence time (yrs) Output from g-res
wrt <- 0.0062
print(paste0("Water residence time (yrs): ", wrt))

# annual discharge
q_annual <- 42.73
print(paste0("Annual Discharge (m3/s): ", q_annual))

# p concentration (ug/L) Output from g-res
p_conc <- 7.1
print(paste0("P Concentration (ug/L): ", p_conc))

# global horizontal radiance
rad <- 3.4
print(paste0("Global horizontal radiance: ", rad))

# mean temperature per month
temp <- data.frame(Jan = 2, Feb = 4, Mar = 5.5, Apr = 7.6, May = 10.6, June = 13.4, July = 15.5, Aug = 15.9, Sept = 13.4, Oct = 9.2, Nov = 5.1, Dec = 2.9) %>% pivot_longer(cols = Jan:Dec, names_to = "Month", values_to = "Temperature")
print("Temperature per month (C)")
temp

```


# Before

## Reservoir surface emissions

**G-res tool**

https://131.datatrium.com/fmi/webd/G-res%20Tool?script=ChoiceWebPage&param=Grestool&homeurl=https://g-res.hydropower.org

**Required data**

Must know

- reservoir age
- P concentration (ug/L) or population in the catchment and category of wastewater treatment
- water residence time or mean depth
- reservoir area (km^2)
- reservoir climate zone
- maximum depth
- mean depth or volume

Can be derived from other inputs

- % littoral area
- water residence time

Can be calculated from Google Earth Engine script given a delineated catchment with 
https://code.earthengine.google.com/db5542fcc97469961bfd890123aa55df

- mean annual air temperature (C)
- reservoir surface soil carbon content (kgC m^-2)
- cumulative global horizontal radiance (kWh m^-2 d-1)
- catchment area (km2)
- annual runoff (mm/yr)
- catchment landcover (%)
- k factor (soil erodibility factor)
- mean basin slope

Can delineate catchments in US reservoirs using the StreamStats tool 
https://streamstats.usgs.gov/ss/ 

```{r gres outputs}
# g CO2
res_co2_diff <- 43
res_ch4_diff_eq <- 87 * 0.6
res_ch4_eb_eq <- 87 * 0.4
res_ch4_degas_eq <- 120 * 0.28

# total including degassing emissions
res_emissions_degas_eq <- 163
res_emissions_degas_eq_2.5 <- 145
res_emissions_degas_eq_97.5 <- 183

# total not including degassing emissions
res_emissions_eq <- 130
res_emissions_eq_2.5 <- 115
res_emissions_eq_97.5 <- 146
```

## Reservoir carbon burial
```{r}
sed_mod <- NULL
perc_carbon_mod <- NULL

# make sure res_area units are correct. st_area will use projection units
new_sed_data <- data.frame(surface_area = res_area, slope = res_slope, forest = perc_forest, crops = perc_crop)
new_carbon_data <- data.frame(soc = res_soc, )

# may need to deal with transformation in estimating PI
oc <- NULL
# generate prediction interval for sed_mod
predict(sed_mod, new_sed_data, interval = "prediction")
```

# Burp

## Exposed sediment emissions
```{r}
# sample range of sediment depths for C to mineralized
sed_depth <- runif(n, max = max_sed_depth, min = 0)

# sample range of possible sediment lability
labile <- runif(n, max = max_prop_labile, min = min_prop_labile)

# function to calculate dry bulk density (g m-3)
dbd <- function(oc){
  return(1.665 * (oc^-0.887))
}

# find a way to include range of OC % may need to map function 

# check units and unit conversions (should output g)
sed_depth * res_area * 10000 * dbd(oc) * labile
```

## Drawdown ebullition 
```{r}
# we may instead want to present a couple of scenarios rather than injecting a bunch of noise here
eb_prop <- runif(n, min = min_eb_prop, max = max_eb_prop)

# next step is to discard top and bottom proportion 
drawdown_eb <- eb_prop * res_ch4_eb
```

## Eroded sediment emissions
```{r}
prop_ox <- runif(n, min = min_ox_trans, max = max_ox_trans)

# depending on how mass vs volume is presented in the literature, may need to add unit conversions and/or use dry bulk density to get mass
erode_emissions <- erode_sed * ox * prop_ox
```

## River surface emissions
```{r}
# create a look up table for both binned CO2 and binned CH4 emissions by Q

# TODO bin Stanley et al. 2023 emissions
```

# Build

## River surface emissions
```{r}
# create a look up table for both binned CO2 and binned CH4 emissions by Q

# TODO bin Stanley et al. 2023 emissions
```

## ?? Doesn't this depend on whether FVS is giving NPP or NEP. If NPP, then do we need to include soil surface CO2 and CH4 emissions and tree CH4 emissions (including dead wood CH4 emissions)

```{r}
vec <- runif(20, 0, 10)

hist(vec)

sample(vec, 100, replace = T) %>% hist(breaks = c(0, 2, 4, 6, 8, 10))
```